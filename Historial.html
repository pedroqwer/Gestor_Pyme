<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Historial</title>
  <style>
    body {
      font-family: "Poppins", sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f5f5f5;
      color: #333;
      position: relative;
      z-index: 1;
    }

    /* ==== MENÚ DESPLEGABLE ==== */
    nav.menu-desplegable {
      background-color: #2c3e50;
      padding: 0.5em 1em;
      display: flex;
      justify-content: flex-start;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.25);
    }

    .dropdown { position: relative; }
    .dropbtn {
      background-color: #2c3e50;
      color: #ecf0f1;
      padding: 10px 18px;
      font-size: 1rem;
      font-weight: 600;
      border: none;
      cursor: pointer;
      border-radius: 8px;
      transition: background-color 0.3s, transform 0.2s;
    }

    .dropbtn:hover {
      background-color: #1c80c8;
      transform: scale(1.05);
    }

    .dropdown-content {
      display: none;
      position: absolute;
      background-color: #34495e;
      min-width: 220px;
      margin-top: 5px;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0px 8px 16px rgba(0, 0, 0, 0.25);
      z-index: 1000;
    }

    .dropdown-content a {
      color: white;
      padding: 12px 18px;
      text-decoration: none;
      display: block;
      font-size: 0.95rem;
    }

    .dropdown-content a:hover {
      background-color: #1c80c8;
    }

    .dropdown:hover .dropdown-content {
      display: block;
    }

    /* ==== CONTENEDOR PRINCIPAL ==== */
    .container {
      display: grid;
      grid-template-columns: 1fr 2fr;
      height: calc(100vh - 60px);
      position: relative;
      z-index: 10;
    }

    /* ==== PANEL HISTORIAL ==== */
    .historial {
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(8px);
      border-right: 2px solid rgba(0,0,0,0.1);
      overflow-y: auto;
      box-shadow: 2px 0 10px rgba(0,0,0,0.1);
      animation: slideInLeft 0.8s ease;
    }

    .historial h2 {
      margin: 0;
      padding: 18px;
      background: #1c3d5a;
      color: white;
      font-size: 1.3em;
      letter-spacing: 0.5px;
      position: sticky;
      top: 0;
    }

    .historial ul {
      list-style: none;
      margin: 0;
      padding: 0;
    }

    .historial li {
      padding: 14px 18px;
      cursor: pointer;
      transition: all 0.25s ease;
      border-bottom: 1px solid rgba(0,0,0,0.05);
    }

    .historial li:hover {
      background: rgba(28, 128, 200, 0.15);
      transform: translateX(4px);
    }

    .historial li.active {
      background: rgba(28, 128, 200, 0.3);
      font-weight: 600;
      border-left: 4px solid #1c80c8;
    }

    /* ==== PANEL DETALLES ==== */
    .detalles {
      padding: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow-y: auto;
      animation: fadeIn 1s ease;
    }

    .detalle-box {
      background: rgba(255, 255, 255, 0.95);
      padding: 30px;
      border-radius: 16px;
      max-width: 750px;
      width: 100%;
      box-shadow: 0 6px 18px rgba(0,0,0,0.15);
      transition: transform 0.3s, box-shadow 0.3s;
    }

    .detalle-box:hover {
      transform: translateY(-4px);
      box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    }

    .detalle-box h3 {
      margin-top: 0;
      color: #1c80c8;
      border-bottom: 2px solid #e5e5e5;
      padding-bottom: 0.5em;
    }

    .detalle-box p {
      line-height: 1.6;
      font-size: 1.05em;
      color: #555;
    }

    /* ==== ANIMACIONES ==== */
    @keyframes slideInLeft {
      from { transform: translateX(-100%); }
      to { transform: translateX(0); }
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    /* ==== FONDO ANIMADO (Mismo estilo que Clientes/Login) ==== */
    #backgroundCanvas {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      z-index: 0;
      pointer-events: none;
      background: #0f2027;
    }

    @media (max-width: 900px) {
      .container {
        grid-template-columns: 1fr;
      }
      .historial {
        height: 40%;
        border-right: none;
        border-bottom: 2px solid rgba(0,0,0,0.1);
      }
      .detalles {
        height: 60%;
        padding: 20px;
      }
    }
  </style>
</head>
<body>

<canvas id="backgroundCanvas"></canvas>

<nav class="menu-desplegable">
    <div class="dropdown">
      <button class="dropbtn">☰ Menú</button>
      <div class="dropdown-content">
        <a href="Inventario.html">Inventario</a>
        <a href="Clientes.html">Clientes</a>
        <a href="Productos.html">Productos</a>
        <a href="Top_Ventas.html">Más vendidos</a>
        <a href="Ventas.html">Ventas</a>
        <a href="Registrar_Entrada.html">Registrar Entrada nuevo producto</a>
        <a href="Proveedores.html">Proveedores</a>
        <a href="historial.html">Historial</a>
        <a href="Salidas.html">Salidas</a>
        <a href="Movimientos.html">Movimientos</a>
        <a href="Pagos.html">Pagos</a>
        <a href="Login.html" id="logoutLink">Cerrar sesión</a>
      </div>
    </div>
  </nav>

<div class="container">
  <div class="historial">
    <h2>Historial</h2>
    <ul id="lista-historial">
      <li>Cargando registros...</li>
    </ul>
  </div>
  <div class="detalles">
    <div class="detalle-box" id="detalle">
      <h3>Selecciona un registro</h3>
      <p>Haz clic en un registro del historial para ver los detalles completos aquí.</p>
    </div>
  </div>
</div>

<script>
  const listaHistorial = document.getElementById("lista-historial");
  const detalleBox = document.getElementById("detalle");
  const jefeId = localStorage.getItem('jefe_id');

  if (!jefeId) {
    alert("No se encontró el ID del jefe. Redirigiendo al login...");
    window.location.href = "Login.html";
  } else {
    fetch(`http://localhost:3000/historial?jefe_id=${jefeId}`)
      .then(res => res.json())
      .then(data => {
        listaHistorial.innerHTML = "";
        if (!data || data.length === 0) {
          listaHistorial.innerHTML = "<li>No hay registros en el historial.</li>";
          return;
        }

        data.forEach(item => {
          const li = document.createElement("li");
          li.textContent = `${item.accion} - ${formatearFecha(item.fecha)}`;
          li.dataset.detalle = item.descripcion;
          listaHistorial.appendChild(li);
        });

        document.querySelectorAll("#lista-historial li").forEach(item => {
          item.addEventListener("click", () => {
            document.querySelectorAll("#lista-historial li").forEach(li => li.classList.remove("active"));
            item.classList.add("active");
            const textoDetalle = item.getAttribute("data-detalle");
            detalleBox.innerHTML = `
              <h3>${item.textContent}</h3>
              <p>${textoDetalle}</p>
            `;
          });
        });
      })
      .catch(err => {
        console.error("Error al obtener historial:", err);
        listaHistorial.innerHTML = "<li>Error al cargar historial.</li>";
      });
  }

  function formatearFecha(fechaISO) {
    const fecha = new Date(fechaISO);
    return fecha.toLocaleDateString("es-ES", {
      day: "2-digit", month: "2-digit", year: "numeric"
    });
  }

  // ==== FONDO ANIMADO (mismo script que Clientes) ====
  const canvas = document.getElementById('backgroundCanvas');
  const ctx = canvas.getContext('2d');
  let width, height;

  function resize() {
    width = window.innerWidth;
    height = window.innerHeight;
    canvas.width = width;
    canvas.height = height;
  }
  window.addEventListener('resize', resize);
  resize();

  class Shape {
    constructor() { this.reset(); }
    reset() {
      this.x = Math.random() * width;
      this.y = Math.random() * height;
      this.size = 50 + Math.random() * 80;
      this.speedX = (Math.random() * 0.3 + 0.05) * (Math.random() < 0.5 ? 1 : -1);
      this.speedY = (Math.random() * 0.2 + 0.03) * (Math.random() < 0.5 ? 1 : -1);
      this.opacity = 0.05 + Math.random() * 0.15;
      this.color = `rgba(0, 140, 186, ${this.opacity})`;
      this.type = Math.floor(Math.random() * 3);
      this.rotation = Math.random() * 2 * Math.PI;
      this.rotationSpeed = (Math.random() - 0.5) * 0.002;
    }
    draw(ctx) {
      ctx.save();
      ctx.translate(this.x, this.y);
      ctx.rotate(this.rotation);
      ctx.fillStyle = this.color;
      switch (this.type) {
        case 0:
          ctx.beginPath();
          ctx.arc(0, 0, this.size / 2, 0, Math.PI * 2);
          ctx.fill();
          break;
        case 1:
          ctx.beginPath();
          ctx.moveTo(0, -this.size / 1.5);
          ctx.lineTo(this.size / 1.3, this.size / 2);
          ctx.lineTo(-this.size / 1.3, this.size / 2);
          ctx.closePath();
          ctx.fill();
          break;
        case 2:
          const r = this.size / 5;
          ctx.beginPath();
          ctx.moveTo(-this.size / 2 + r, -this.size / 2);
          ctx.lineTo(this.size / 2 - r, -this.size / 2);
          ctx.quadraticCurveTo(this.size / 2, -this.size / 2, this.size / 2, -this.size / 2 + r);
          ctx.lineTo(this.size / 2, this.size / 2 - r);
          ctx.quadraticCurveTo(this.size / 2, this.size / 2, this.size / 2 - r, this.size / 2);
          ctx.lineTo(-this.size / 2 + r, this.size / 2);
          ctx.quadraticCurveTo(-this.size / 2, this.size / 2, -this.size / 2, this.size / 2 - r);
          ctx.lineTo(-this.size / 2, -this.size / 2 + r);
          ctx.quadraticCurveTo(-this.size / 2, -this.size / 2, -this.size / 2 + r, -this.size / 2);
          ctx.closePath();
          ctx.fill();
          break;
      }
      ctx.restore();
    }
    update() {
      this.x += this.speedX;
      this.y += this.speedY;
      this.rotation += this.rotationSpeed;
      if (this.x > width + this.size) this.x = -this.size;
      else if (this.x < -this.size) this.x = width + this.size;
      if (this.y > height + this.size) this.y = -this.size;
      else if (this.y < -this.size) this.y = height + this.size;
    }
  }

  const shapes = [];
  for (let i = 0; i < 35; i++) shapes.push(new Shape());

  function animate() {
    ctx.clearRect(0, 0, width, height);
    shapes.forEach(s => { s.update(); s.draw(ctx); });
    requestAnimationFrame(animate);
  }
  animate();

  document.getElementById('logoutLink').addEventListener('click', async (e) => {
    e.preventDefault();
      try {
        const res = await fetch('http://localhost:3000/generar-respaldo', { method: 'POST' });
        if (!res.ok) throw new Error('Fallo en la generación del respaldo');
        console.log("✅ Respaldo generado correctamente");
      } catch (err) {
        console.error('❌ Error al generar respaldo:', err);
        alert("No se pudo generar el respaldo. Cierre de sesión de todas formas.");
      }

      localStorage.removeItem('jefe_id');
      localStorage.removeItem('usuario');
      window.location.href = 'Login.html';
    });
</script>
</body>
</html>
