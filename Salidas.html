<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Salidas de Inventario</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f5f8fa; margin: 0; }
    nav.menu-desplegable { background: #2c3e50; padding: 0.5em 1em; }
    .container { max-width: 900px; margin: 2em auto; background: #fff; border-radius: 12px; box-shadow: 0 4px 24px rgba(44,62,80,0.08); padding: 2em; }
    .encabezado { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5em; flex-wrap: wrap; }
    .encabezado h1 { color: #1c80c8; font-size: 2em; margin: 0; }
    table { width: 100%; border-collapse: collapse; margin-top: 1em; background: #fff; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.07); }
    th, td { padding: 12px 15px; border-bottom: 1px solid #e0e0e0; text-align: left; font-size: 1em; }
    th { background-color: #1c3d5a; color: white; text-transform: uppercase; letter-spacing: 0.05em; }
    tbody tr:nth-child(even) { background-color: #f9f9f9; }
    tbody tr:hover { background-color: #d6e4f0; cursor: pointer; }
    .botonesDiv { display: flex; gap: 15px; margin-top: 1.5em; justify-content: flex-end; }
    .butons { padding: 10px 20px; background: #1c80c8; color: white; border: none; border-radius: 7px; cursor: pointer; font-size: 1em; font-weight: 600; transition: background 0.2s; }
    .butons:hover { background: #1560a8; }
    .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.3); justify-content: center; align-items: center; z-index: 1000; }
    .modal-content { background: #fff; padding: 2em 1.5em; border-radius: 12px; box-shadow: 0 8px 32px rgba(44,62,80,0.13); min-width: 320px; max-width: 95vw; text-align: left; }
    .modal-content h2 { color: #1c80c8; margin-top: 0; }
    .modal-content label { display: block; margin-top: 1em; font-weight: 600; }
    .modal-content input, .modal-content textarea, .modal-content select { width: 100%; padding: 8px; margin-top: 5px; border-radius: 6px; border: 1px solid #e5e9f2; font-size: 1em; }
    .modal-content button { margin-top: 1.5em; padding: 10px 20px; background: #27ae60; color: white; border: none; border-radius: 7px; font-weight: 600; cursor: pointer; transition: background 0.2s; }
    .modal-content button:hover { background: #1e8449; }
    .cerrar { float: right; font-size: 1.5em; color: #888; cursor: pointer; margin-top: -10px; }
  </style>
</head>
<body>
  <nav class="menu-desplegable">
    <div class="dropdown">
      <button class="dropbtn">☰ Menú</button>
      <div class="dropdown-content">
        <a href="Inventario.html">Inventario</a>
        <a href="Salidas.html">Salidas</a>
        <a href="Clientes.html">Clientes</a>
        <a href="Productos.html">Productos</a>
        <a href="Ventas.html">Ventas</a>
        <a href="Devoluciones.html">Devoluciones</a>
        <a href="Proveedores.html">Proveedores</a>
        <a href="Movimientos.html">Movimientos</a>
        <a href="Login.html" id="logoutLink">Cerrar sesión</a>
      </div>
    </div>
  </nav>
  <div class="container">
    <div class="encabezado">
      <h1>Salidas de Inventario</h1>
    </div>
    <table>
      <thead>
        <tr>
          <th>Producto</th>
          <th>Cantidad</th>
          <th>Fecha</th>
          <th>Motivo</th>
        </tr>
      </thead>
      <tbody id="salidasBody"></tbody>
    </table>
    <div class="botonesDiv">
      <button class="butons" id="AddSalida">Registrar salida</button>
    </div>
  </div>
  <!-- Modal para agregar salida -->
  <div class="modal" id="modalSalida">
    <div class="modal-content">
      <span class="cerrar" onclick="cerrarModal()">&times;</span>
      <h2>Registrar salida</h2>
      <form id="formSalida">
        <label for="producto_id">Producto:</label>
        <select id="producto_id" name="producto_id" required></select>
        <label for="cantidad">Cantidad:</label>
        <input type="number" id="cantidad" name="cantidad" min="1" required>
        <label for="observacion">Motivo:</label>
        <textarea id="observacion" name="observacion" rows="2"></textarea>
        <button type="submit">Registrar salida</button>
      </form>
    </div>
  </div>
  <script>
    const jefeId = localStorage.getItem('jefe_id');
    if (!jefeId) {
      alert('No hay sesión iniciada. Por favor, inicia sesión.');
      window.location.href = 'Login.html';
    }
    const salidasBody = document.getElementById('salidasBody');
    let productos = [];
    let salidas = [];

    function cargarSalidas() {
      fetch(`http://localhost:3000/salidas?jefe_id=${jefeId}`)
        .then(res => res.json())
        .then(data => {
          salidas = Array.isArray(data) ? data : [];
          mostrarSalidas();
        });
    }
    function mostrarSalidas() {
      salidasBody.innerHTML = '';
      salidas.forEach(s => {
        salidasBody.innerHTML += `
          <tr>
            <td>${s.producto || s.producto_id}</td>
            <td>${s.cantidad}</td>
            <td>${new Date(s.fecha).toLocaleString()}</td>
            <td>${s.observacion || ''}</td>
          </tr>
        `;
      });
    }
    function cargarProductos() {
      fetch(`http://localhost:3000/productos?jefe_id=${jefeId}`)
        .then(res => res.json())
        .then(data => {
          productos = Array.isArray(data) ? data : [];
          const select = document.getElementById('producto_id');
          select.innerHTML = productos.map(p => `<option value="${p.id}">${p.nombre}</option>`).join('');
        });
    }
    document.getElementById('AddSalida').addEventListener('click', () => {
      cargarProductos();
      document.getElementById('modalSalida').style.display = 'flex';
    });
    function cerrarModal() {
      document.getElementById('modalSalida').style.display = 'none';
      document.getElementById('formSalida').reset();
    }
    document.getElementById('formSalida').addEventListener('submit', function(e) {
      e.preventDefault();
      const producto_id = document.getElementById('producto_id').value;
      const cantidad = document.getElementById('cantidad').value;
      const observacion = document.getElementById('observacion').value;
      fetch('http://localhost:3000/salidas/registrar', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          producto_id,
          cantidad,
          observacion,
          jefe_id: jefeId
        })
      })
      .then(res => {
        if (res.ok) {
          cerrarModal();
          cargarSalidas();
        } else {
          alert('Error al registrar salida');
        }
      });
    });
    cargarSalidas();
    window.addEventListener('click', function(event) {
      const modal = document.getElementById('modalSalida');
      if (event.target === modal) cerrarModal();
    });
  </script>
</body>
</html>