<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Movimientos de Inventario</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f5f5f5;
      position: relative;
      z-index: 1;
    }

    /* MENÃš DESPLEGABLE ESTILO MODERNO */
    nav.menu-desplegable {
      background-color: #2c3e50;
      padding: 0.5em 1em;
      display: flex;
      justify-content: flex-start;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.25);
    }

    .dropdown { position: relative; }
    .dropbtn {
      background-color: #2c3e50;
      color: #ecf0f1;
      padding: 10px 18px;
      font-size: 1rem;
      font-weight: 600;
      border: none;
      cursor: pointer;
      border-radius: 8px;
      transition: background-color 0.3s, transform 0.2s;
    }
    .dropbtn:hover { background-color: #1c80c8; transform: scale(1.05); }
    .dropdown-content {
      display: none;
      position: absolute;
      background-color: #34495e;
      min-width: 220px;
      margin-top: 5px;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0px 8px 16px rgba(0, 0, 0, 0.25);
      z-index: 1000;
    }
    .dropdown-content a {
      color: #ecf0f1;
      padding: 12px 16px;
      text-decoration: none;
      display: block;
      transition: background 0.3s;
    }
    .dropdown-content a:hover { background-color: #1c80c8; }
    .dropdown:hover .dropdown-content { display: block; }

    .container {
      padding: 2em;
      position: relative;
      z-index: 10;
    }

    #titulo {
      color: #64ffda;
      text-align: center;
      font-size: 2.2em;
      font-weight: 700;
      margin: 20px 0;
      text-shadow: 0px 0px 8px rgba(100, 255, 218, 0.5);
    }

    .acciones {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5em;
      gap: 10px;
    }

    .acciones input, .acciones select {
      padding: 10px;
      border: 2px solid #ccc;
      border-radius: 8px;
      font-size: 1em;
    }

    button {
      padding: 10px 20px;
      background: #1a17ad;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 1em;
      transition: background-color 0.3s ease;
    }
    button:hover { background-color: #000000; }

    #totales {
      margin-top: 15px;
      font-weight: bold;
      text-align: center;
      color: #0d3d56;
    }

    /* Contenedor de tabla desplazable */
    .tabla-contenedor {
      max-height: 400px; /* altura de la tabla */
      overflow-y: auto;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      background-color: white;
      margin-top: 1em;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th, td {
      padding: 12px 15px;
      border-bottom: 1px solid #e0e0e0;
      text-align: left;
      font-size: 0.95em;
    }

    th {
      background-color: #1c3d5a;
      color: white;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    tbody tr:nth-child(even) { background-color: #f9f9f9; }
    tbody tr:hover {
      background-color: #d6e4f0;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }

    /* Fondo animado estilo Login */
    #backgroundCanvas {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      z-index: 0;
      pointer-events: none;
      background: #0f2027;
    }

    @media (max-width: 768px) {
      .acciones { flex-direction: column; align-items: stretch; }
      table, thead, tbody, th, td, tr { display: block; }
      th { display: none; }
      td {
        position: relative;
        padding-left: 50%;
        border: none;
        border-bottom: 1px solid #ccc;
      }
      td::before {
        position: absolute;
        left: 10px;
        top: 10px;
        white-space: nowrap;
        font-weight: bold;
        content: attr(data-label);
      }
    }
  </style>
</head>
<body>
  <!-- MENÃš -->
  <nav class="menu-desplegable">
    <div class="dropdown">
      <button class="dropbtn">â˜° MenÃº</button>
      <div class="dropdown-content">
        <a href="Inventario.html">Inventario</a>
        <a href="Clientes.html">Clientes</a>
        <a href="Productos.html">Productos</a>
        <a href="Top_Ventas.html">MÃ¡s vendidos</a>
        <a href="Ventas.html">Ventas</a>
        <a href="Devoluciones.html">Devoluciones</a>
        <a href="Registrar_Entrada.html">Registrar Entrada nuevo producto</a>
        <a href="Proveedores.html">Proveedores</a>
        <a href="historial.html">Historial</a>
        <a href="Salidas.html">Salidas</a>
        <a href="Movimientos.html">Movimientos</a>
        <a href="Pagos.html">Pagos</a>
        <a href="Login.html" id="logoutLink">Cerrar sesiÃ³n</a>
      </div>
    </div>
  </nav>

  <div class="container">
    <h1 id="titulo">ðŸ“¦ Movimientos de Inventario</h1>

    <div class="acciones">
      <input type="text" id="buscar" placeholder="ðŸ” Buscar producto u observaciÃ³n...">
      <select id="filtroTipo">
        <option value="">Todos los tipos</option>
        <option value="entrada">Entradas</option>
        <option value="salida">Salidas</option>
        <option value="venta">Ventas</option>
      </select>
      <input type="date" id="filtroFecha">
      <div>
        <button onclick="cargarMovimientos()">ðŸ”„ Refrescar</button>
        <button onclick="limpiarFiltros()">ðŸ§¹ Limpiar</button>
        <button onclick="exportarCSV()">ðŸ“„ Exportar CSV</button>
      </div>
    </div>

    <div id="totales">Totales: Entradas: 0 | Salidas: 0 | Ventas: 0</div>

    <div class="tabla-contenedor">
      <table id="tablaMovimientos">
        <thead>
          <tr>
            <th>Tipo</th>
            <th>Producto</th>
            <th>Cantidad</th>
            <th>Fecha</th>
            <th>ObservaciÃ³n</th>
          </tr>
        </thead>
        <tbody>
          <tr><td colspan="5" style="text-align:center; color:#777;">Cargando movimientos...</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <canvas id="backgroundCanvas"></canvas>

  <script>
    let movimientosCache = [];

    async function cargarMovimientos() {
      const jefeId = localStorage.getItem("jefe_id");
      if (!jefeId) {
        alert("No has iniciado sesiÃ³n");
        window.location.href = "Login.html";
        return;
      }
      try {
        const res = await fetch(`http://localhost:3000/movimientos?jefe_id=${jefeId}`);
        const movimientos = await res.json();
        movimientosCache = movimientos;
        mostrarMovimientos(movimientos);
      } catch (err) {
        console.error(err);
        alert("Error al cargar los movimientos");
      }
    }

    function mostrarMovimientos(lista) {
      const tbody = document.querySelector("#tablaMovimientos tbody");
      tbody.innerHTML = "";

      if (lista.length === 0) {
        tbody.innerHTML = `<tr><td colspan="5" style="text-align:center; color:#777;">No hay movimientos encontrados</td></tr>`;
        return;
      }

      lista.forEach(m => {
        const fila = document.createElement("tr");
        const fechaMovimiento = new Date(m.fecha);
        fila.innerHTML = `
          <td data-label="Tipo">${m.tipo}</td>
          <td data-label="Producto">${m.producto_nombre || "â€”"}</td>
          <td data-label="Cantidad">${m.cantidad}</td>
          <td data-label="Fecha">${fechaMovimiento.toLocaleString()}</td>
          <td data-label="ObservaciÃ³n">${m.observacion || "â€”"}</td>
        `;
        fila.addEventListener("click", () => {
          let url = "";
          if (m.tipo === "venta") url = `detalle_venta.html?id=${m.id}`;
          else if (m.tipo === "entrada") url = `detalle_entrada.html?id=${m.entrada_id}`; // âš¡ aquÃ­ usamos entrada_id
          else if (m.tipo === "salida") url = `detalle_salida.html?id=${m.id}`;
          if (url) window.location.href = url;
        });

        tbody.appendChild(fila);
      });
      actualizarTotales(lista);
    }
    
    document.getElementById('logoutLink').addEventListener('click', async (e) => {
    e.preventDefault();
      try {
        const res = await fetch('http://localhost:3000/generar-respaldo', { method: 'POST' });
        if (!res.ok) throw new Error('Fallo en la generaciÃ³n del respaldo');
        console.log("âœ… Respaldo generado correctamente");
      } catch (err) {
        console.error('âŒ Error al generar respaldo:', err);
        alert("No se pudo generar el respaldo. Cierre de sesiÃ³n de todas formas.");
      }

      localStorage.removeItem('jefe_id');
      localStorage.removeItem('usuario');
      window.location.href = 'Login.html';
    });

    function aplicarFiltros() {
      const texto = document.getElementById("buscar").value.toLowerCase();
      const tipo = document.getElementById("filtroTipo").value;
      const fecha = document.getElementById("filtroFecha").value;

      let filtrados = movimientosCache;
      if (texto)
        filtrados = filtrados.filter(m =>
          m.producto.toLowerCase().includes(texto) ||
          (m.observacion && m.observacion.toLowerCase().includes(texto))
        );
      if (tipo) filtrados = filtrados.filter(m => m.tipo === tipo);
      if (fecha) filtrados = filtrados.filter(m => m.fecha.startsWith(fecha));

      mostrarMovimientos(filtrados);
    }

    function limpiarFiltros() {
      document.getElementById("buscar").value = "";
      document.getElementById("filtroTipo").value = "";
      document.getElementById("filtroFecha").value = "";
      mostrarMovimientos(movimientosCache);
    }

    function actualizarTotales(lista) {
      const totalEntradas = lista.filter(m => m.tipo === 'entrada').reduce((a,b) => a+b.cantidad, 0);
      const totalSalidas = lista.filter(m => m.tipo === 'salida').reduce((a,b) => a+b.cantidad, 0);
      const totalVentas = lista.filter(m => m.tipo === 'venta').reduce((a,b) => a+b.cantidad, 0);
      document.getElementById("totales").innerText =
        `Totales: Entradas: ${totalEntradas} | Salidas: ${totalSalidas} | Ventas: ${totalVentas}`;
    }

    function exportarCSV() {
      if (movimientosCache.length === 0) {
        alert("No hay movimientos para exportar.");
        return;
      }
      const lista = movimientosCache.map(m => ({
        ID: m.id,
        Tipo: m.tipo,
        Producto: m.producto,
        Cantidad: m.cantidad,
        Fecha: new Date(m.fecha).toLocaleString(),
        Observacion: m.observacion || ""
      }));
      const csv = [Object.keys(lista[0]).join(','), ...lista.map(r => Object.values(r).map(v => `"${v}"`).join(','))].join('\n');
      const blob = new Blob([csv], { type: 'text/csv' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `movimientos_${new Date().toISOString().slice(0,10)}.csv`;
      a.click();
      URL.revokeObjectURL(a.href);
    }

    document.getElementById("buscar").addEventListener("input", aplicarFiltros);
    document.getElementById("filtroTipo").addEventListener("change", aplicarFiltros);
    document.getElementById("filtroFecha").addEventListener("change", aplicarFiltros);

    // Fondo animado
    const canvas = document.getElementById('backgroundCanvas');
    const ctx = canvas.getContext('2d');
    let width, height;
    function resize() { width = window.innerWidth; height = window.innerHeight; canvas.width = width; canvas.height = height; }
    window.addEventListener('resize', resize); resize();

    class Shape {
      constructor(){ this.reset(); }
      reset(){
        this.x = Math.random()*width;
        this.y = Math.random()*height;
        this.size = 50 + Math.random()*80;
        this.speedX = (Math.random()*0.3+0.05)*(Math.random()<0.5?1:-1);
        this.speedY = (Math.random()*0.2+0.03)*(Math.random()<0.5?1:-1);
        this.opacity = 0.05 + Math.random()*0.15;
        this.color = `rgba(0,140,186,${this.opacity})`;
        this.type = Math.floor(Math.random()*3);
        this.rotation = Math.random()*2*Math.PI;
        this.rotationSpeed = (Math.random()-0.5)*0.002;
      }
      draw(ctx){
        ctx.save(); ctx.translate(this.x,this.y); ctx.rotate(this.rotation); ctx.fillStyle=this.color;
        switch(this.type){
          case 0: ctx.beginPath(); ctx.arc(0,0,this.size/2,0,Math.PI*2); ctx.fill(); break;
          case 1: ctx.beginPath(); ctx.moveTo(0,-this.size/1.5); ctx.lineTo(this.size/1.3,this.size/2); ctx.lineTo(-this.size/1.3,this.size/2); ctx.closePath(); ctx.fill(); break;
          case 2:
            const r=this.size/5;
            ctx.beginPath();
            ctx.moveTo(-this.size/2+r,-this.size/2);
            ctx.lineTo(this.size/2-r,-this.size/2);
            ctx.quadraticCurveTo(this.size/2,-this.size/2,this.size/2,-this.size/2+r);
            ctx.lineTo(this.size/2,this.size/2-r);
            ctx.quadraticCurveTo(this.size/2,this.size/2,this.size/2-r,this.size/2);
            ctx.lineTo(-this.size/2+r,this.size/2);
            ctx.quadraticCurveTo(-this.size/2,this.size/2,-this.size/2,this.size/2-r);
            ctx.lineTo(-this.size/2,-this.size/2+r);
            ctx.quadraticCurveTo(-this.size/2,-this.size/2,-this.size/2+r,-this.size/2);
            ctx.closePath();
            ctx.fill();
            break;
        }
        ctx.restore();
      }
      update() {
        this.x+=this.speedX; this.y+=this.speedY; this.rotation+=this.rotationSpeed;
        if(this.x>width+this.size) this.x=-this.size;
        else if(this.x<-this.size) this.x=width+this.size;
        if(this.y>height+this.size) this.y=-this.size;
        else if(this.y<-this.size) this.y=height+this.size;
      }
    }
    const shapes=[]; const maxShapes=35; for(let i=0;i<maxShapes;i++) shapes.push(new Shape());
    function animate(){ ctx.clearRect(0,0,width,height); for(let shape of shapes){ shape.update(); shape.draw(ctx); } requestAnimationFrame(animate);}
    animate();

    // Cargar movimientos inicial
    cargarMovimientos();
  </script>
</body>
</html>
