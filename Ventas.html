<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pantalla de Ventas</title>
  <style>
    * { box-sizing: border-box; }
    body { font-family: 'Segoe UI', sans-serif; margin: 0; padding: 0; background-color: #0f2027; overflow: hidden; position: relative; z-index: 1; height: 100vh; display: flex; flex-direction: column; }
    nav.menu-desplegable { background-color: #2c3e50; padding: 0.5em 1em; display: flex; justify-content: flex-start; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 6px rgba(0,0,0,0.25); }
    .dropdown { position: relative; }
    .dropbtn { background-color: #2c3e50; color: #ecf0f1; padding: 10px 18px; font-size: 1rem; font-weight: 600; border: none; cursor: pointer; border-radius: 8px; transition: background-color 0.3s, transform 0.2s; }
    .dropbtn:hover { background-color: #1c80c8; transform: scale(1.05); }
    .dropdown-content { display: none; position: absolute; background-color: #34495e; min-width: 220px; margin-top: 5px; border-radius: 8px; overflow: hidden; box-shadow: 0px 8px 16px rgba(0,0,0,0.25); z-index: 1000; }
    .dropdown-content a { color: #ecf0f1; padding: 12px 16px; text-decoration: none; display: block; transition: background 0.3s; }
    .dropdown-content a:hover { background-color: #1c80c8; }
    .dropdown:hover .dropdown-content { display: block; }
    .container { flex: 1; display: flex; flex-direction: row; height: calc(100vh - 60px); padding: 1.2em; gap: 1em; z-index: 10; overflow: hidden; }
    .products, .cart { background-color: rgba(255,255,255,0.95); border-radius: 12px; padding: 1.5em; box-shadow: 0 2px 8px rgba(0,0,0,0.2); display: flex; flex-direction: column; overflow: hidden; }
    .products { flex: 3; }
    .cart { flex: 2; }
    h2 { margin-top: 0; color: #1c3d5a; text-align: center; }
    #searchInput { padding: 8px 12px; margin-bottom: 1em; font-size: 1em; border-radius: 6px; border: 1px solid #ccc; width: 100%; transition: border-color 0.3s ease; }
    #searchInput:focus { border-color: #1c80c8; outline: none; }
    .tabla-container { flex: 1; overflow-y: auto; max-height: calc(100vh - 250px); border-radius: 10px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 12px 15px; border-bottom: 1px solid #e0e0e0; text-align: left; font-size: 0.95em; }
    th { background-color: #1c3d5a; color: white; text-transform: uppercase; position: sticky; top: 0; z-index: 5; }
    tbody tr:nth-child(even) { background-color: #f9f9f9; }
    tbody tr:hover { background-color: #d6e4f0; }
    button { padding: 8px 14px; background: #1c80c8; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 0.95em; transition: background-color 0.3s ease, transform 0.2s; }
    button:hover { background-color: #145f91; transform: scale(1.05); }
    .generate-invoice-btn { margin-top: auto; padding: 14px; font-weight: 700; font-size: 1em; border-radius: 8px; background-color: #1c3d5a; box-shadow: 0 2px 6px rgba(0,0,0,0.3); }
    .generate-invoice-btn:hover { background-color: #000; }
    .cart-list { flex: 1; overflow-y: auto; margin-top: 1em; display: flex; flex-direction: column; gap: 10px; }
    .cart-item { display: flex; justify-content: space-between; align-items: center; background-color: #f1f1f1; border: 1px solid #ddd; border-radius: 8px; padding: 10px 15px; }
    .modal-overlay { position: fixed; top:0; left:0; right:0; bottom:0; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index:2000; }
    .modal-content { background:white; padding:20px; border-radius:10px; width:90%; max-width:400px; }
    .modal-buttons { display:flex; justify-content:flex-end; gap:10px; margin-top:20px; }
    #backgroundCanvas { position: fixed; top:0; left:0; width:100vw; height:100vh; z-index:0; pointer-events:none; background:#0f2027; }
    @media(max-width:768px){ .container{ flex-direction:column; height:auto; } }
  </style>
</head>
<body>
<nav class="menu-desplegable">
    <div class="dropdown">
      <button class="dropbtn">‚ò∞ Men√∫</button>
      <div class="dropdown-content">
        <a href="Inventario.html">Inventario</a>
        <a href="Clientes.html">Clientes</a>
        <a href="Productos.html">Productos</a>
        <a href="Top_Ventas.html">M√°s vendidos</a>
        <a href="Ventas.html">Ventas</a>
        <a href="Registrar_Entrada.html">Registrar Entrada nuevo producto</a>
        <a href="Proveedores.html">Proveedores</a>
        <a href="historial.html">Historial</a>
        <a href="Salidas.html">Salidas</a>
        <a href="Movimientos.html">Movimientos</a>
        <a href="Pagos.html">Pagos</a>
        <a href="Login.html" id="logoutLink">Cerrar sesi√≥n</a>
      </div>
    </div>
  </nav>

  <div class="container">
    <div class="products">
      <h2>üõçÔ∏è Productos Disponibles</h2>
      <input type="text" id="searchInput" placeholder="Buscar producto..." />
      <div class="tabla-container">
        <table>
          <thead>
            <tr>
              <th>Nombre</th>
              <th>Precio Venta</th>
              <th>Acci√≥n</th>
            </tr>
          </thead>
          <tbody id="productTable"></tbody>
        </table>
      </div>
    </div>

    <div class="cart">
      <h2>üßæ Productos Seleccionados</h2>
      <div id="cartList" class="cart-list"></div>
      <button class="generate-invoice-btn" onclick="generarFactura()">Generar Factura</button>
    </div>
  </div>

  <canvas id="backgroundCanvas"></canvas>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script>
    // Fondo animado (igual que antes)
    const canvas=document.getElementById('backgroundCanvas'),ctx=canvas.getContext('2d');
    let width,height;
    function resize(){ width=window.innerWidth; height=window.innerHeight; canvas.width=width; canvas.height=height; }
    window.addEventListener('resize',resize); resize();
    class Shape{ constructor(){ this.reset(); } reset(){ this.x=Math.random()*width; this.y=Math.random()*height; this.size=50+Math.random()*80; this.speedX=(Math.random()*0.3+0.05)*(Math.random()<0.5?1:-1); this.speedY=(Math.random()*0.2+0.03)*(Math.random()<0.5?1:-1); this.opacity=0.05+Math.random()*0.15; this.color=`rgba(0,140,186,${this.opacity})`; this.rotation=Math.random()*Math.PI*2; this.rotationSpeed=(Math.random()-0.5)*0.002; this.type=Math.floor(Math.random()*3); } draw(ctx){ ctx.save(); ctx.translate(this.x,this.y); ctx.rotate(this.rotation); ctx.fillStyle=this.color; if(this.type===0){ctx.beginPath();ctx.arc(0,0,this.size/2,0,Math.PI*2);ctx.fill();} else if(this.type===1){ctx.beginPath();ctx.moveTo(0,-this.size/1.5);ctx.lineTo(this.size/1.3,this.size/2);ctx.lineTo(-this.size/1.3,this.size/2);ctx.closePath();ctx.fill();} else{const r=this.size/5; ctx.beginPath();ctx.moveTo(-this.size/2+r,-this.size/2);ctx.lineTo(this.size/2-r,-this.size/2);ctx.quadraticCurveTo(this.size/2,-this.size/2,this.size/2,-this.size/2+r); ctx.lineTo(this.size/2,this.size/2-r);ctx.quadraticCurveTo(this.size/2,this.size/2,this.size/2-r,this.size/2); ctx.lineTo(-this.size/2+r,this.size/2);ctx.quadraticCurveTo(-this.size/2,this.size/2,-this.size/2,this.size/2-r); ctx.lineTo(-this.size/2,-this.size/2+r);ctx.quadraticCurveTo(-this.size/2,-this.size/2,-this.size/2+r,-this.size/2); ctx.closePath();ctx.fill();} ctx.restore(); } update(){ this.x+=this.speedX; this.y+=this.speedY; this.rotation+=this.rotationSpeed; if(this.x>width+this.size)this.x=-this.size; else if(this.x<-this.size)this.x=width+this.size; if(this.y>height+this.size)this.y=-this.size; else if(this.y<-this.size)this.y=height+this.size; } }
    const shapes=Array.from({length:35},()=>new Shape());
    function animate(){ ctx.clearRect(0,0,width,height); shapes.forEach(s=>{s.update(); s.draw(ctx);}); requestAnimationFrame(animate);}
    animate();
  </script>

  <script>
    const { jsPDF } = window.jspdf;
    const productTable=document.getElementById("productTable");
    const cartList=document.getElementById("cartList");
    const searchInput=document.getElementById("searchInput");
    const carrito=[];
    let productosGlobal=[], clientesGlobal=[];
    const jefeId=localStorage.getItem('jefe_id');

    if(!jefeId){ alert("No has iniciado sesi√≥n."); window.location.href="Login.html"; }
    logoutLink.addEventListener('click',()=>{ localStorage.removeItem('jefe_id'); localStorage.removeItem('usuario'); });

    async function obtenerProductos(){
      try{ const res=await fetch(`http://localhost:3000/productos/venta?jefe_id=${jefeId}`); if(!res.ok)throw new Error(`Error HTTP: ${res.status}`); productosGlobal=await res.json(); renderProductos(productosGlobal);}
      catch(e){ console.error(e); alert("Error al cargar productos."); }
    }
    async function obtenerClientes(){
      try{ const res=await fetch(`http://localhost:3000/clientes?jefe_id=${jefeId}`); if(!res.ok)throw new Error(`Error HTTP: ${res.status}`); clientesGlobal=await res.json();}
      catch(e){ console.error(e); alert("No se pudieron cargar los clientes."); }
    }

    function renderProductos(productos){
      productTable.innerHTML="";
      if(productos.length===0){ productTable.innerHTML="<tr><td colspan='3' style='text-align:center;'>No hay productos disponibles</td></tr>"; return; }
      productos.forEach(p=>{ const fila=document.createElement("tr"); fila.innerHTML=`<td>${p.nombre}</td><td>$${parseFloat(p.precio_venta).toFixed(2)}</td><td><button onclick="agregarAlCarrito(${p.id},'${p.nombre}',${p.precio_venta})">Agregar</button></td>`; productTable.appendChild(fila); });
    }

    function agregarAlCarrito(id,nombre,precio_venta){ const prod=carrito.find(item=>item.id===id); if(prod) prod.cantidad++; else carrito.push({id,nombre,precio:parseFloat(precio_venta),cantidad:1}); renderCarrito(); }
    function eliminarDelCarrito(i){ carrito.splice(i,1); renderCarrito(); }
    function renderCarrito(){
      cartList.innerHTML=""; if(carrito.length===0){ cartList.innerHTML="<p style='text-align:center;'>El carrito est√° vac√≠o</p>"; return; }
      carrito.forEach((p,i)=>{ const subtotal=p.precio*p.cantidad; const item=document.createElement("div"); item.className="cart-item"; item.innerHTML=`<span>${p.nombre} - $${p.precio.toFixed(2)} x ${p.cantidad} = $${subtotal.toFixed(2)}</span><button onclick="eliminarDelCarrito(${i})">Eliminar</button>`; cartList.appendChild(item); });
    }

    function seleccionarClienteYPago(){
      return new Promise(resolve=>{
        if(clientesGlobal.length===0){ alert("No hay clientes."); resolve(null); return; }
        const overlay=document.createElement("div"); overlay.className="modal-overlay";
        const modal=document.createElement("div"); modal.className="modal-content";
        modal.innerHTML=`
          <h3>Selecciona cliente y m√©todo de pago</h3>
          <label for="clienteSelect">Cliente:</label>
          <select id="clienteSelect" style="width:100%; padding:8px; margin:10px 0;">
            ${clientesGlobal.map(c=>`<option value="${c.id}">${c.nombre}</option>`).join('')}
          </select>
          <label for="metodoPagoSelect">M√©todo de pago:</label>
          <select id="metodoPagoSelect" style="width:100%; padding:8px; margin:10px 0;">
            <option value="efectivo">Efectivo</option>
            <option value="tarjeta">Tarjeta</option>
            <option value="transferencia">Transferencia</option>
            <option value="credito">Cr√©dito</option>
          </select>
          <div class="modal-buttons">
            <button id="btnCancelar">Cancelar</button>
            <button id="btnAceptar">Aceptar</button>
          </div>`;
        overlay.appendChild(modal); document.body.appendChild(overlay);
        document.getElementById("btnAceptar").onclick=()=>{
          const clienteId=parseInt(document.getElementById("clienteSelect").value);
          const metodo=document.getElementById("metodoPagoSelect").value;
          document.body.removeChild(overlay);
          resolve({clienteId, metodo});
        };
        document.getElementById("btnCancelar").onclick=()=>{ document.body.removeChild(overlay); resolve(null); };
      });
    }

    document.getElementById('logoutLink').addEventListener('click', async (e) => {
    e.preventDefault();
      try {
        const res = await fetch('http://localhost:3000/generar-respaldo', { method: 'POST' });
        if (!res.ok) throw new Error('Fallo en la generaci√≥n del respaldo');
        console.log("‚úÖ Respaldo generado correctamente");
      } catch (err) {
        console.error('‚ùå Error al generar respaldo:', err);
        alert("No se pudo generar el respaldo. Cierre de sesi√≥n de todas formas.");
      }

      localStorage.removeItem('jefe_id');
      localStorage.removeItem('usuario');
      window.location.href = 'Login.html';
    });
    
    async function generarFactura(){
      if(carrito.length===0){ alert("El carrito est√° vac√≠o."); return; }
      const seleccion=await seleccionarClienteYPago();
      if(!seleccion){ alert("Debe seleccionar cliente y m√©todo de pago."); return; }
      const { clienteId, metodo } = seleccion;
      const venta={ cliente_id:clienteId, jefe_id:jefeId, productos: carrito.map(p=>({id:p.id,cantidad:p.cantidad,precio:p.precio})) };
      try{
        const resVenta=await fetch("http://localhost:3000/ventas/registrar",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(venta)});
        if(!resVenta.ok){ const errorData=await resVenta.json(); throw new Error(errorData.error||"Error al registrar la venta"); }
        const ventaData=await resVenta.json(); const ventaId=ventaData.venta_id;

        const totalPago=carrito.reduce((sum,p)=>sum+p.precio*p.cantidad,0);
        const resPago=await fetch("http://localhost:3000/pagos/registrar",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({ venta_id:ventaId, jefe_id:jefeId, metodo, monto:totalPago })});
        if(!resPago.ok){ const errorPago=await resPago.json(); throw new Error(errorPago.error||"Error al registrar el pago"); }

        generarPDFFactura(clienteId);
        carrito.length=0; renderCarrito();
        alert("Venta y pago registrados con √©xito!");
      } catch(e){ console.error(e); alert("Error: "+e.message); }
    }

    function generarPDFFactura(clienteId){
      const cliente=clientesGlobal.find(c=>c.id===clienteId)||{nombre:"Cliente no especificado"};
      const fecha=new Date().toLocaleDateString();
      const doc=new jsPDF();
      doc.setFontSize(20); doc.setTextColor(0,0,0); doc.text("FACTURA DE VENTA",105,20,{align:"center"});
      doc.setFontSize(12); doc.text(`Cliente: ${cliente.nombre}`,14,30); doc.text(`Fecha: ${fecha}`,150,30);
      let yPos=40; const columnas={producto:14,cantidad:90,precio:120,subtotal:150};
      doc.setFontSize(14); doc.text("Producto",columnas.producto,yPos); doc.text("Cant.",columnas.cantidad,yPos); doc.text("Precio",columnas.precio,yPos); doc.text("Subtotal",columnas.subtotal,yPos);
      yPos+=6; doc.setLineWidth(0.5); doc.line(14,yPos,196,yPos); yPos+=10;
      doc.setFontSize(12); let total=0;
      carrito.forEach(p=>{ const subtotal=p.precio*p.cantidad; total+=subtotal; doc.text(p.nombre,columnas.producto,yPos); doc.text(String(p.cantidad),columnas.cantidad,yPos); doc.text(`$${p.precio.toFixed(2)}`,columnas.precio,yPos); doc.text(`$${subtotal.toFixed(2)}`,columnas.subtotal,yPos); yPos+=8; });
      doc.line(14,yPos,196,yPos); yPos+=10;
      doc.setFontSize(16); doc.setTextColor(0,128,0); doc.text(`TOTAL: $${total.toFixed(2)}`,columnas.subtotal,yPos);
      doc.save(`Factura_${cliente.nombre.replace(/\s+/g,'_')}_${fecha.replace(/\//g,'-')}.pdf`);
    }

    searchInput.addEventListener("input",()=>{ const filtro=searchInput.value.toLowerCase(); renderProductos(productosGlobal.filter(p=>p.nombre.toLowerCase().includes(filtro))); });

    document.addEventListener('DOMContentLoaded',()=>{ obtenerProductos(); obtenerClientes(); });
  </script>
</body>
</html>
